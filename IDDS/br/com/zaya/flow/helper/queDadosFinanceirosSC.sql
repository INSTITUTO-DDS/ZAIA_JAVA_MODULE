SELECT DISTINCT F.NUFIN,
                SRC.IDINSTPRN,
                TAR.IDELEMENTO,
                E.NOME,
                FAT.CODBARRAS,
                CONCAT(
                        'AJUSTE FISCAL: ', APV.OBSNF,
                        CHAR (13), CHAR (10), CHAR (13), CHAR (10),
                        'AJUSTE SOLICITANTE: ', APV.OBSSOLICFIN
                ) AS AJUSTESTEXT
FROM TGFFIN AS F

CROSS APPLY
(
  SELECT T.TNF_IDINSTPRN
  FROM TGFCAB_TNF AS T
  WHERE T.NUNOTA = F.NUNOTA
    AND T.TNF_IDINSTPRN IS NOT NULL

  UNION ALL

  SELECT FT.TNF_IDINSTPRN
  FROM TGFFIN_TNF AS FT
  WHERE FT.NUFIN  = F.NUFIN
    AND FT.TNF_IDINSTPRN IS NOT NULL
) AS SRC(IDINSTPRN)

INNER JOIN TWFITAR   TAR
ON TAR.IDINSTPRN = SRC.IDINSTPRN
    INNER JOIN TWFIPRN PRN ON PRN.IDINSTPRN = TAR.IDINSTPRN
    INNER JOIN AD_APROVACAO APV ON APV.IDINSTPRN = PRN.IDINSTPRN
    INNER JOIN TWFELE E ON E.CODPRN = PRN.CODPRN
    AND E.VERSAO = PRN.VERSAO
    AND E.IDELEMENTO = TAR.IDELEMENTO
    INNER JOIN AD_TWFTSF TPRN ON TPRN.CODPRN = PRN.CODPRN
    AND TPRN.NOME = E.NOME
    INNER JOIN AD_FATCONNOTAS FAT ON FAT.IDINSTPRN = SRC.IDINSTPRN
WHERE
    TAR.DHCONCLUSAO IS NULL
  AND TAR.SITUACAOEXEC <> 'F'
  AND F.DHBAIXA IS NULL
  AND (
    SRC.IDINSTPRN IS NOT NULL
   OR (
    F.AD_IDPROCESSO IS NOT NULL
  AND F.NUCOMPENS IS NOT NULL
  AND F.RECDESP = -1
    )
    )
  --AND F.NUFIN = :NUFIN
  AND F.IDINSTPRN IS NOT NULL
  AND APV.CODREGISTRO = (SELECT
    MAX (CODREGISTRO)
    FROM AD_APROVACAO
    WHERE IDINSTPRN = SRC.IDINSTPRN)